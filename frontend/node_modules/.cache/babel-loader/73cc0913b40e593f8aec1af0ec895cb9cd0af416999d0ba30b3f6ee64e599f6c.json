{"ast":null,"code":"import React,{useReducer,useEffect,useCallback}from\"react\";import{Streamlit}from\"streamlit-component-lib\";import{useRenderData}from\"../utils/StreamlitProvider\";import{initialState,reducer}from\"../reducers/highlightReducer\";import{isHighlighted,removeHighlight,getCharactersCountUntilNode,adjustSelectionBounds}from\"../helpers/highlightHelpers\";import{ActionTypes}from\"../types/highlightTypes\";import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";const Highlighter=()=>{const{args}=useRenderData();const[state,dispatch]=useReducer(reducer,initialState);useEffect(()=>{const fetchData=async()=>{const{text,highlights}=args;dispatch({type:ActionTypes.SET_TEXT_HIGHLIGHTS,payload:{text,highlights}});dispatch({type:ActionTypes.RENDER_TEXT});Streamlit.setComponentValue(highlights);};fetchData();},[]);useEffect(()=>{dispatch({type:ActionTypes.RENDER_TEXT});},[state.highlights,state.selectedReference]);const handleMouseUp=useCallback(async()=>{var _document$getSelectio;const selection=(_document$getSelectio=document.getSelection())===null||_document$getSelectio===void 0?void 0:_document$getSelectio.getRangeAt(0);if(selection&&selection.toString().trim()!==\"\"){const container=document.getElementById(\"actual-text\");const charsBeforeStart=getCharactersCountUntilNode(selection.startContainer,container);const charsBeforeEnd=getCharactersCountUntilNode(selection.endContainer,container);const finalStartIndex=selection.startOffset+charsBeforeStart;const finalEndIndex=selection.endOffset+charsBeforeEnd;const textContent=(container===null||container===void 0?void 0:container.textContent)||\"\";const{start,end}=adjustSelectionBounds(textContent,finalStartIndex,finalEndIndex);const selectedText=textContent.slice(start,end);if(isHighlighted(finalStartIndex,finalEndIndex,state.highlights[state.selectedReference])){const highlights=removeHighlight(start,end,state.highlights[state.selectedReference]);const newHighlights=[...state.highlights];newHighlights[state.selectedReference]=highlights;dispatch({type:ActionTypes.SET_TEXT_HIGHLIGHTS,payload:{text:state.text,highlights:newHighlights}});}else{const newHighlight={start,end,label:selectedText};const newHighlights=[...state.highlights];newHighlights[state.selectedReference]=[...newHighlights[state.selectedReference],newHighlight];dispatch({type:ActionTypes.SET_TEXT_HIGHLIGHTS,payload:{text:state.text,highlights:newHighlights}});}}},[state,dispatch]);const addReference=()=>{dispatch({type:ActionTypes.ADD_REFERENCE});};const selectReference=index=>{dispatch({type:ActionTypes.SELECT_REFERENCE,payload:index});};const removeReference=index=>{dispatch({type:ActionTypes.REMOVE_REFERENCE,payload:index});};return/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex flex-row flex-wrap\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"flex flex-wrap justify-between items-center cursor-pointer py-1 px-3 mr-2 mb-2 rounded text-white text-base bg-primary hover:bg-secondary\",onClick:addReference,children:/*#__PURE__*/_jsx(\"span\",{children:\"+\"})}),state.highlights.map((reference,index)=>{var _reference$;return/*#__PURE__*/_jsxs(\"span\",{className:\"flex flex-wrap justify-between items-center cursor-pointer py-1 px-3 mr-2 mb-2 rounded text-base\"+(state.selectedReference===index?\" bg-primary hover:bg-secondary text-white\":\" border border-primary text-primary hover:bg-primary hover:text-white\"),onClick:()=>selectReference(index),children:[(_reference$=reference[0])===null||_reference$===void 0?void 0:_reference$.label,/*#__PURE__*/_jsx(\"svg\",{xmlns:\"http://www.w3.org/2000/svg\",className:\"h-5 w-5 ml-3 hover:text-gray-300\",viewBox:\"0 0 20 20\",fill:\"currentColor\",onClick:()=>removeReference(index),children:/*#__PURE__*/_jsx(\"path\",{fillRule:\"evenodd\",d:\"M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z\"})})]},index);})]}),/*#__PURE__*/_jsx(\"div\",{id:\"actual-text\",className:\"mt-5 h-full\",onMouseUp:handleMouseUp,children:state.actual_text})]});};export default Highlighter;","map":{"version":3,"names":["React","useReducer","useEffect","useCallback","Streamlit","useRenderData","initialState","reducer","isHighlighted","removeHighlight","getCharactersCountUntilNode","adjustSelectionBounds","ActionTypes","jsx","_jsx","jsxs","_jsxs","Highlighter","args","state","dispatch","fetchData","text","highlights","type","SET_TEXT_HIGHLIGHTS","payload","RENDER_TEXT","setComponentValue","selectedReference","handleMouseUp","_document$getSelectio","selection","document","getSelection","getRangeAt","toString","trim","container","getElementById","charsBeforeStart","startContainer","charsBeforeEnd","endContainer","finalStartIndex","startOffset","finalEndIndex","endOffset","textContent","start","end","selectedText","slice","newHighlights","newHighlight","label","addReference","ADD_REFERENCE","selectReference","index","SELECT_REFERENCE","removeReference","REMOVE_REFERENCE","children","className","onClick","map","reference","_reference$","xmlns","viewBox","fill","fillRule","d","id","onMouseUp","actual_text"],"sources":["/Users/yiwang/Documents/ChatYoutube/streamlit-annotation-tools/src/streamlit_annotation_tools/frontend/src/components/Highlighter.tsx"],"sourcesContent":["import React, { useReducer, useEffect, useCallback } from \"react\"\nimport { Streamlit } from \"streamlit-component-lib\"\nimport { useRenderData } from \"../utils/StreamlitProvider\"\nimport { initialState, reducer } from \"../reducers/highlightReducer\"\nimport {\n  isHighlighted,\n  removeHighlight,\n  getCharactersCountUntilNode,\n  adjustSelectionBounds,\n} from \"../helpers/highlightHelpers\"\nimport { IState, ActionTypes, IAction } from \"../types/highlightTypes\"\n\nconst Highlighter: React.FC = () => {\n  const { args } = useRenderData()\n  const [state, dispatch] = useReducer<React.Reducer<IState, IAction>>(\n    reducer,\n    initialState\n  )\n\n  useEffect(() => {\n    const fetchData = async () => {\n      const { text, highlights } = args\n      dispatch({\n        type: ActionTypes.SET_TEXT_HIGHLIGHTS,\n        payload: { text, highlights },\n      })\n      dispatch({ type: ActionTypes.RENDER_TEXT })\n      Streamlit.setComponentValue(highlights)\n    }\n\n    fetchData()\n  }, [])\n\n  useEffect(() => {\n    dispatch({ type: ActionTypes.RENDER_TEXT })\n  }, [state.highlights, state.selectedReference])\n\n  const handleMouseUp = useCallback(async () => {\n    const selection = document.getSelection()?.getRangeAt(0)\n\n    if (selection && selection.toString().trim() !== \"\") {\n      const container = document.getElementById(\"actual-text\")\n      const charsBeforeStart = getCharactersCountUntilNode(\n        selection.startContainer,\n        container\n      )\n      const charsBeforeEnd = getCharactersCountUntilNode(\n        selection.endContainer,\n        container\n      )\n\n      const finalStartIndex = selection.startOffset + charsBeforeStart\n      const finalEndIndex = selection.endOffset + charsBeforeEnd\n\n      const textContent = container?.textContent || \"\"\n\n      const { start, end } = adjustSelectionBounds(\n        textContent,\n        finalStartIndex,\n        finalEndIndex\n      )\n      const selectedText = textContent.slice(start, end)\n\n      if (\n        isHighlighted(\n          finalStartIndex,\n          finalEndIndex,\n          state.highlights[state.selectedReference]\n        )\n      ) {\n        const highlights = removeHighlight(\n          start,\n          end,\n          state.highlights[state.selectedReference]\n        )\n        const newHighlights = [...state.highlights]\n        newHighlights[state.selectedReference] = highlights\n        dispatch({\n          type: ActionTypes.SET_TEXT_HIGHLIGHTS,\n          payload: { text: state.text, highlights: newHighlights },\n        })\n      } else {\n        const newHighlight = { start, end, label: selectedText }\n        const newHighlights = [...state.highlights]\n        newHighlights[state.selectedReference] = [\n          ...newHighlights[state.selectedReference],\n          newHighlight,\n        ]\n        dispatch({\n          type: ActionTypes.SET_TEXT_HIGHLIGHTS,\n          payload: { text: state.text, highlights: newHighlights },\n        })\n      }\n    }\n  }, [state, dispatch])\n\n  const addReference = () => {\n    dispatch({ type: ActionTypes.ADD_REFERENCE })\n  }\n\n  const selectReference = (index: number) => {\n    dispatch({ type: ActionTypes.SELECT_REFERENCE, payload: index })\n  }\n\n  const removeReference = (index: number) => {\n    dispatch({ type: ActionTypes.REMOVE_REFERENCE, payload: index })\n  }\n\n  return (\n    <div>\n      <div className=\"flex flex-row flex-wrap\">\n        <div\n          className=\"flex flex-wrap justify-between items-center cursor-pointer py-1 px-3 mr-2 mb-2 rounded text-white text-base bg-primary hover:bg-secondary\"\n          onClick={addReference}\n        >\n          <span>+</span>\n        </div>\n        {state.highlights.map((reference, index) => (\n          <span\n            key={index}\n            className={\n              \"flex flex-wrap justify-between items-center cursor-pointer py-1 px-3 mr-2 mb-2 rounded text-base\" +\n              (state.selectedReference === index\n                ? \" bg-primary hover:bg-secondary text-white\"\n                : \" border border-primary text-primary hover:bg-primary hover:text-white\")\n            }\n            onClick={() => selectReference(index)}\n          >\n            {reference[0]?.label}\n            <svg\n              xmlns=\"http://www.w3.org/2000/svg\"\n              className=\"h-5 w-5 ml-3 hover:text-gray-300\"\n              viewBox=\"0 0 20 20\"\n              fill=\"currentColor\"\n              onClick={() => removeReference(index)}\n            >\n              <path\n                fillRule=\"evenodd\"\n                d=\"M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z\"\n              />\n            </svg>\n          </span>\n        ))}\n      </div>\n      <div id=\"actual-text\" className=\"mt-5 h-full\" onMouseUp={handleMouseUp}>\n        {state.actual_text}\n      </div>\n    </div>\n  )\n}\n\nexport default Highlighter\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}